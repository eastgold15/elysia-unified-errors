name: Auto Review and Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run type check
        run: bun run typecheck

      - name: Run linting
        run: bun run lint

      - name: Run tests
        run: bun test

      - name: Build package
        run: bun run build

      - name: Check if PR only adds error types
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦åªä¿®æ”¹äº†å…è®¸çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD)
          echo "Changed files: $CHANGED_FILES"
          
          ALLOWED_CHANGES=true
          for file in $CHANGED_FILES; do
            case $file in
              src/index.ts|test/index.test.ts|USAGE.md|README.md)
                echo "âœ… Allowed file: $file"
                ;;
              *)
                echo "âŒ Unauthorized file change: $file"
                ALLOWED_CHANGES=false
                ;;
            esac
          done
          
          echo "allowed_changes=$ALLOWED_CHANGES" >> $GITHUB_OUTPUT

      - name: Check error type additions
        id: check-error-types
        if: steps.check-changes.outputs.allowed_changes == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–°çš„é”™è¯¯ç±»åž‹è€Œä¸æ˜¯ä¿®æ”¹çŽ°æœ‰çš„
          git diff origin/${{ github.base_ref }} HEAD src/index.ts > changes.diff
          
          # æ£€æŸ¥æ˜¯å¦åªæ˜¯æ·»åŠ æ–°çš„æžšä¸¾å€¼æˆ–é”™è¯¯åˆ›å»ºå™¨
          if grep -q "^-.*Error" changes.diff; then
            echo "âŒ Detected removal or modification of existing error types"
            echo "error_types_ok=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Only additions detected"
            echo "error_types_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto approve PR
        if: |
          steps.check-changes.outputs.allowed_changes == 'true' && 
          steps.check-error-types.outputs.error_types_ok == 'true'
        uses: juliangruber/approve-pull-request-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ github.event.pull_request.number }}

      - name: Auto merge PR
        if: |
          steps.check-changes.outputs.allowed_changes == 'true' && 
          steps.check-error-types.outputs.error_types_ok == 'true'
        uses: pascalgn/merge-pull-request-action@v0.15.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash

      - name: Comment on rejection
        if: |
          steps.check-changes.outputs.allowed_changes == 'false' || 
          steps.check-error-types.outputs.error_types_ok == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ è‡ªåŠ¨å®¡æ ¸å¤±è´¥
              
              æ‚¨çš„PRæœªé€šè¿‡è‡ªåŠ¨å®¡æ ¸ã€‚è¯·ç¡®ä¿ï¼š
              
              1. âœ… åªä¿®æ”¹å…è®¸çš„æ–‡ä»¶ï¼š
                 - \`src/index.ts\` - æ·»åŠ æ–°çš„é”™è¯¯ç±»åž‹å’Œåˆ›å»ºå™¨
                 - \`test/index.test.ts\` - æ·»åŠ ç›¸åº”çš„æµ‹è¯•
                 - \`USAGE.md\` æˆ– \`README.md\` - æ›´æ–°æ–‡æ¡£
              
              2. âœ… åªæ·»åŠ æ–°çš„é”™è¯¯ç±»åž‹ï¼Œä¸ä¿®æ”¹æˆ–åˆ é™¤çŽ°æœ‰çš„é”™è¯¯ç±»åž‹
              
              3. âœ… æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡
              
              4. âœ… ä»£ç å¿…é¡»é€šè¿‡ç±»åž‹æ£€æŸ¥å’Œè¯­æ³•æ£€æŸ¥
              
              è¯·ä¿®æ”¹æ‚¨çš„PRåŽé‡æ–°æäº¤ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·åœ¨Issueä¸­è®¨è®ºã€‚`
            })

  # å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆä»…åœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯åŽï¼‰
  release:
    needs: auto-review
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Bump version
        run: |
          # è‡ªåŠ¨å¢žåŠ è¡¥ä¸ç‰ˆæœ¬å·
          current_version=$(node -p "require('./package.json').version")
          new_version=$(echo $current_version | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "Bumping version from $current_version to $new_version"
          
          # æ›´æ–°package.json
          sed -i "s/\"version\": \"$current_version\"/\"version\": \"$new_version\"/" package.json
          
          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json
          git commit -m "chore: bump version to $new_version"
          git push

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          release_name: Release v${{ steps.bump.outputs.new_version }}
          body: |
            ðŸŽ‰ è‡ªåŠ¨å‘å¸ƒæ–°ç‰ˆæœ¬ï¼
            
            æœ¬ç‰ˆæœ¬åŒ…å«äº†ç¤¾åŒºè´¡çŒ®çš„æ–°é”™è¯¯ç±»åž‹ã€‚
            
            ## å˜æ›´å†…å®¹
            ${{ github.event.pull_request.title }}
            
            æ„Ÿè°¢ @${{ github.event.pull_request.user.login }} çš„è´¡çŒ®ï¼
          draft: false
          prerelease: false

      - name: Publish to npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm publish --access public
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}